<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Webpage Title -->
        <title>Habits</title>

        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

        <!-- favicon -->
        <link rel="shortcut icon" href="{{ url_for('static', filename='diary.png') }}" />

        <!-- JS -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"
        ></script>

        <!-- FullCalendar-Moment -->
        <script class="cssdesk" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.0/moment.min.js" type="text/javascript"></script>

        <!-- êµ¬ê¸€í°íŠ¸ -->
        <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet" />

        <!-- FontAwesome -->
        <link
            rel="stylesheet"
            href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
            integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
            crossorigin="anonymous"
        />

        <!-- CSS -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/daygrid.css') }}?1=1" />
        <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/fullcalendar.css') }}?1=4" />
        <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}?1=16" />
        <link rel="stylesheet" href="{{ url_for('static', filename='css/habit.css') }}?1=8" />

        <!-- JS -->
        <script src="{{ url_for('static', filename='js/vendor/fullcalendar.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/daygrid.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/interaction.js') }}"></script>
        <script src="{{ url_for('static', filename='js/vendor/chart.js') }}"></script>
        <script src="{{ url_for('static', filename='js/calendar.js') }}?1=40"></script>
        <script src="{{ url_for('static', filename='js/modal.js') }}?1=2"></script>
        <style>
            .btn__container {
                padding-top: 20px;
                background-color: #fff;
                color: #fba09d;
            }
            .btn__container button {
                text-transform: uppercase;
            }
            .btn__container button:first-child {
                margin-right: 5px;
            }
        </style>
    </head>

    <body>
        <div class="header">
            <h1>{{ username }}ë‹˜ì˜ ìŠµê´€ë‹¬ë ¥&nbsp;<i class="fas fa-book-open"></i></h1>
        </div>

        <!-- ìŠµê´€ëª©ë¡ -->
        <div class="btn__container">
            <button onClick="goHome()" type="button" class="default-btn">Home</button>
            <button type="button" class="default-btn goToday">Today</button>
        </div>

        <div id="external-events">
            <p><i class="far fa-list-alt"></i>&nbsp;<strong>ë‚˜ì˜ ìŠµê´€ëª©ë¡</strong></p>
            {% for habit in habits %}
            <div class="fc-event {{habit.color}}">{{ habit.habit }}</div>
            {% endfor %}
            <button onClick="openAddHabits()" type="button" class="default-btn">ìŠµê´€ì¶”ê°€</button>
            <button onClick="openChartModal()" type="button" class="default-btn">í†µê³„</button>
        </div>

        <!-- ìŠµê´€ ìˆ˜ì •/ì‚­ì œ -->
        <div id="multiModal" class="modal">
            <div class="content multiModal__content">
                <div class="row">
                    <h2>ìŠµê´€ìˆ˜ì •</h2>
                </div>
                <div class="row">
                    <label class="label" for="habitName">ìŠµê´€ì´ë¦„</label>
                    <input type="text" id="habitName" />
                    <label class="label" for="color">ìƒ‰ìƒ</label>
                    <select name="color" id="select-color">
                        <option value="deep-blue">ë‚¨ìƒ‰</option>
                        <option value="green">ì´ˆë¡</option>
                        <option value="orange">ì£¼í™©</option>
                        <option value="yellow">ë…¸ë‘</option>
                        <option value="beige">ë² ì´ì§€</option>
                        <option value="pink">í•‘ì¿ </option>
                        <option value="burgendy">ë²„ê±´ë””</option>
                        <option value="grey">íšŒìƒ‰</option>
                    </select>
                </div>
                <div class="row">
                    <button type="button" class="default-btn" id="close-btn">ë‹«ê¸°</button>
                    <button type="button" class="delete-btn" id="delete-btn">ì‚­ì œ</button>
                    <button type="button" class="save-btn" id="save-btn">ì €ì¥</button>
                </div>
            </div>
        </div>

        <!-- ìŠµê´€ì¶”ê°€ -->
        <div id="addHabits" class="modal">
            <div class="content addHabits__content">
                <div class="row">
                    <h2>ìŠµê´€ë“±ë¡</h2>
                </div>
                <div class="row">
                    <label class="label" for="habit">ìŠµê´€ì´ë¦„</label>
                    <input type="text" id="habit" name="habit" />
                    <label class="label" for="color">ìƒ‰ìƒ</label>
                    <select name="color" id="add__select-color">
                        <option value="deep-blue">ë‚¨ìƒ‰</option>
                        <option value="green">ì´ˆë¡</option>
                        <option value="orange">ì£¼í™©</option>
                        <option value="yellow">ë…¸ë‘</option>
                        <option value="beige">ë² ì´ì§€</option>
                        <option value="pink">í•‘ì¿ </option>
                        <option value="burgendy">ë²„ê±´ë””</option>
                        <option value="grey">íšŒìƒ‰</option>
                    </select>
                </div>
                <div class="row">
                    <button type="button" class="default-btn" onClick="closeAddHabits()">ë‹«ê¸°</button>
                    <button type="button" class="save-btn" onClick="addHabits()">ë“±ë¡</button>
                </div>
            </div>
        </div>

        <!-- ë‹¬ë ¥ -->
        <div id="calendar"></div>

        <!-- í†µê³„ì°¨íŠ¸ -->
        <div id="chart__container" class="modal">
            <div class="content chart__content">
                <div class="box">
                    <div class="chart__column">
                        <span>ì›” ì„ íƒ :</span>
                        <select name="selectMonth" id="selectMonth">
                            <option value="01">JAN</option>
                            <option value="02">FEB</option>
                            <option value="03">MAR</option>
                            <option value="04">APR</option>
                            <option value="05">MAY</option>
                            <option value="06">JUN</option>
                            <option value="07">JUL</option>
                            <option value="08">AUG</option>
                            <option value="09">SEP</option>
                            <option value="10">OCT</option>
                            <option value="11">NOV</option>
                            <option value="12">DEC</option>
                        </select>
                        <button type="button" onClick="openChart()" class="default-btn">ë³´ê¸°</button>
                    </div>
                    <div class="chart__column">
                        <button type="button" class="default-btn" onClick="closeChart()">ë‹«ê¸°</button>
                    </div>
                </div>
                <div class="box">
                    <div id="graph" class="modal">
                        <h2>í•œë‹¬ì— ì´ë§Œí¼ í–ˆë„¤ìš” ğŸ˜„</h2>
                        <div>
                            <canvas id="myChart" height="500" width="1000"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const Calendar = FullCalendar.Calendar;
            const Draggable = FullCalendarInteraction.Draggable;

            const containerEl = document.getElementById("external-events");
            const calendarEl = document.getElementById("calendar");

            // initialize the external events
            new Draggable(containerEl, {
                itemSelector: ".fc-event",
                eventData: function (eventEl) {
                    return {
                        title: eventEl.innerText,
                    };
                },
            });

            // initialize the calendar
            const calendar = new Calendar(calendarEl, {
                plugins: ["interaction", "dayGrid"],
                header: { left: "prev", center: "title", right: "next" },
                editable: false,
                droppable: true,
                displayEventTime: false,
                progressiveEventRendering: true,
                eventReceive: function (event, _) {
                    const email = location.search.split("=")[1];
                    const colorName = event.draggedEl.classList[1];

                    if (colorName === "deep-blue") color = "#4d638c";
                    else if (colorName === "green") color = "#83b799";
                    else if (colorName === "orange") color = "#ffa94d";
                    else if (colorName === "yellow") color = "#e2cd6d";
                    else if (colorName === "beige") color = "#c3b28f";
                    else if (colorName === "pink") color = "#e86f68";
                    else if (colorName === "burgendy") color = "#881d1d";
                    else if (colorName === "grey") color = "#495057";

                    $.ajax({
                        type: "POST",
                        url: "/habits-date",
                        data: {
                            date: moment(event.event.start).format("YYYY-MM-DDThh:mm"),
                            title: event.event.title,
                            email: email,
                            colorName: colorName,
                            color: color,
                        },
                        dataType: "json",
                        success: function (response) {
                            if (response["result"] == "success") {
                                window.location.reload();
                            } else {
                                alert("ì„œë²„ ì˜¤ë¥˜!");
                            }
                        },
                    });
                },
                timeZone: "local",
                eventClick: function (info) {
                    const target = info.event;

                    const targetId = target.extendedProps._id;
                    const targetName = target.title;

                    const deleteMsg = confirm(`ì •ë§ë¡œ "${targetName}" ìŠµê´€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);

                    if (deleteMsg) {
                        target.remove();
                        $.ajax({
                            url: "/habits-delete",
                            type: "POST",
                            data: { targetId_give: targetId },
                            success: function (response) {
                                if (response["result"] == "success") {
                                    console.log("ì‚­ì œì„±ê³µ");
                                }
                            },
                        });
                    }
                },
                eventSources: [
                    {
                        events: function (_, successCallback, __) {
                            const currentEmail = location.search.split("=")[1];
                            $.ajax({
                                url: "/habits-date",
                                type: "GET",
                                dataType: "json",
                                data: {},
                                success: function (response) {
                                    const eventsList = response["events_list"];

                                    let event = [];
                                    for (let i = 0; i < eventsList.length; i++) {
                                        if (eventsList[i].email === currentEmail) {
                                            event.push(eventsList[i]);
                                        }
                                    }

                                    successCallback(event);
                                },
                            });
                        },
                    },
                ],
            });

            $(document).on("click", ".fc-next-button,.fc-prev-button", function () {
                const text = $(".fc-center h2").text();
                const month = text.split(" ")[0];
                const year = text.split(" ")[1];

                let monthNum = [];
                if (month === "January") monthNum.push("01");
                else if (month === "February") monthNum.push("02");
                else if (month === "March") monthNum.push("03");
                else if (month === "April") monthNum.push("04");
                else if (month === "May") monthNum.push("05");
                else if (month === "June") monthNum.push("06");
                else if (month === "July") monthNum.push("07");
                else if (month === "August") monthNum.push("08");
                else if (month === "September") monthNum.push("09");
                else if (month === "October") monthNum.push("10");
                else if (month === "November") monthNum.push("11");
                else if (month === "December") monthNum.push("12");

                const saveMonth = `${year}-${monthNum}-01`;
                sessionStorage.setItem("savedMonth", saveMonth);
            });

            $(".goToday").click(() => {
                calendar.today();
                const text = $(".fc-center h2").text();
                const month = text.split(" ")[0];
                const year = text.split(" ")[1];

                let monthNum = [];
                if (month === "January") monthNum.push("01");
                else if (month === "February") monthNum.push("02");
                else if (month === "March") monthNum.push("03");
                else if (month === "April") monthNum.push("04");
                else if (month === "May") monthNum.push("05");
                else if (month === "June") monthNum.push("06");
                else if (month === "July") monthNum.push("07");
                else if (month === "August") monthNum.push("08");
                else if (month === "September") monthNum.push("09");
                else if (month === "October") monthNum.push("10");
                else if (month === "November") monthNum.push("11");
                else if (month === "December") monthNum.push("12");

                const saveMonth = `${year}-${monthNum}-01`;
                sessionStorage.setItem("savedMonth", saveMonth);
            });

            if (sessionStorage.getItem("savedMonth") != null) {
                calendar.gotoDate(sessionStorage.getItem("savedMonth"));
            }

            calendar.render();
        });

        function goHome() {
            window.location.href = "http://0.0.0.0:5000/";
        }

        // ìŠµê´€ ìˆ˜ì •/ì‚­ì œ ëª¨ë‹¬
        $("#external-events div").click((e) => {
            const modal = $("#multiModal");
            const content = $("#multiModal .multiModal__content");
            const marginLeft = content.outerWidth() / 2;
            const marginTop = content.outerHeight() / 2;

            if (modal.css("display") === "none") {
                modal.fadeIn(400);
                content.css({
                    "margin-top": -marginTop,
                    "margin-left": -marginLeft,
                });
            }
            bgLayerOpen();

            // ì²˜ìŒ ì„¤ì •í•œ habit ìƒ‰ê¹” select boxì— ëœ¨ê²Œ ì„¤ì •
            const colorName = e.target.classList[1];

            if (e.target.classList[1] === "deep-blue") {
                $("#select-color option:eq(0)").prop("selected", true);
            }
            if (e.target.classList[1] === "green") {
                $("#select-color option:eq(1)").prop("selected", true);
            }
            if (e.target.classList[1] === "orange") {
                $("#select-color option:eq(2)").prop("selected", true);
            }
            if (e.target.classList[1] === "yellow") {
                $("#select-color option:eq(3)").prop("selected", true);
            }
            if (e.target.classList[1] === "beige") {
                $("#select-color option:eq(4)").prop("selected", true);
            }
            if (e.target.classList[1] === "pink") {
                $("#select-color option:eq(5)").prop("selected", true);
            }
            if (e.target.classList[1] === "burgendy") {
                $("#select-color option:eq(6)").prop("selected", true);
            }
            if (e.target.classList[1] === "grey") {
                $("#select-color option:eq(7)").prop("selected", true);
            }

            const currentEmail = location.search.split("=")[1];

            // ëª¨ë‹¬ì°½ì— ì›ë˜ ìŠµê´€ ì´ë¦„ ë³´ì´ê¸°
            const targetName = e.target.innerHTML;
            $("#habitName").val(targetName);

            // ìŠµê´€ ì‚­ì œ
            $("#delete-btn").click((e) => {
                $.ajax({
                    type: "POST",
                    url: "/habits-delete2",
                    data: {
                        email: currentEmail,
                        title: targetName,
                    },
                    success: () => {
                        $("#multiModal").fadeOut(400);
                        bgLayerClear();
                        window.location.reload();
                    },
                });
            });

            // ìŠµê´€ ìˆ˜ì •ì‚¬í•­ ë³€ê²½
            $("#save-btn").click(() => {
                const newName = $("#habitName").val();
                const newColorName = $("#select-color option:checked").val();

                if (newColorName === "deep-blue") color = "#4d638c";
                else if (newColorName === "green") color = "#83b799";
                else if (newColorName === "orange") color = "#ffa94d";
                else if (newColorName === "yellow") color = "#e2cd6d";
                else if (newColorName === "beige") color = "#c3b28f";
                else if (newColorName === "pink") color = "#e86f68";
                else if (newColorName === "burgendy") color = "#881d1d";
                else if (newColorName === "grey") color = "#495057";

                if (colorName !== newColorName) {
                    $(e.target).attr(`${colorName}`, `${newColorName}`);
                    $(".fc-event").attr(`${colorName}`, `${newColorName}`);
                }

                $.ajax({
                    type: "POST",
                    url: "/habits-edit",
                    data: {
                        email: currentEmail,
                        title: targetName,
                        newTitle: newName,
                        colorName: colorName,
                        newColorName: newColorName,
                        color: color,
                    },
                    dataType: "json",
                    success: function (response) {
                        if (response["result"] === "success") {
                            window.location.reload();
                        } else {
                            alert("error");
                        }
                    },
                });
            });

            $("#close-btn").click(() => {
                $("#multiModal").fadeOut(400);
                bgLayerClear();
            });
        });
    </script>
</html>
